name: ORT License Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  ort-license-check:
    runs-on: ubuntu-latest
    name: ORT License Compliance Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Setup Java 21
      uses: actions/setup-java@v4
      with:
        distribution: 'temurin'
        java-version: '21'

    - name: Install ORT
      run: |
        echo "Installing ORT CLI..."
        wget -q https://github.com/oss-review-toolkit/ort/releases/download/74.1.0/ort-74.1.0.tgz
        tar -xzf ort-74.1.0.tgz
        echo "$(pwd)/ort-74.1.0/bin" >> $GITHUB_PATH
        echo "ORT_DATA_DIR=$(pwd)/.ort" >> $GITHUB_ENV

    - name: Run ORT Analyzer
      run: |
        echo "========================================="
        echo "Running ORT Analyzer on NuGet packages..."
        echo "========================================="
        mkdir -p .ort/analyzer
        ort analyze \
          --package-managers NuGet \
          --output-dir .ort/analyzer \
          --output-formats YAML,JSON \
          .
        echo "Analyzer complete."
        ls -lah .ort/analyzer/

    - name: Run ORT Evaluator
      run: |
        echo "==========================================="
        echo "Running ORT Evaluator with policy rules..."
        echo "==========================================="
        mkdir -p .ort/evaluator
        ort evaluate \
          --input-file .ort/analyzer/analyzer-result.yml \
          --rules-file .ort/policy/rules.kts \
          --output-dir .ort/evaluator \
          --output-formats YAML,JSON
        echo "Evaluator complete."
        ls -lah .ort/evaluator/

    - name: Run ORT Reporter
      run: |
        echo "======================================="
        echo "Generating ORT compliance reports..."
        echo "======================================="
        mkdir -p .ort/reporter
        ort report \
          --input-file .ort/analyzer/analyzer-result.yml \
          --report-formats CycloneDx,SpdxDocument,WebApp \
          --output-dir .ort/reporter
        echo "Reporter complete."
        ls -lah .ort/reporter/

    - name: Check for Policy Violations
      run: |
        echo "======================================="
        echo "Checking for license policy violations..."
        echo "======================================="
        if grep -q "violations:" .ort/evaluator/evaluation-result.yml; then
          echo "‚ùå License policy violations detected!"
          echo "Review the evaluation results for details."
          grep -A 20 "violations:" .ort/evaluator/evaluation-result.yml || true
          exit 1
        else
          echo "‚úÖ No license policy violations found."
        fi

    - name: Upload ORT Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-results
        path: |
          .ort/analyzer/*.yml
          .ort/analyzer/*.json
          .ort/evaluator/*.yml
          .ort/evaluator/*.json
          .ort/reporter/**/*
        retention-days: 90
        
    - name: Upload License Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-reports
        path: |
          .ort/reporter/*
        retention-days: 90

    - name: Comment PR with Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const evaluationFile = '.ort/evaluator/evaluation-result.yml';
          
          let comment = '## üìã ORT License Compliance Results\n\n';
          
          if (fs.existsSync(evaluationFile)) {
            const content = fs.readFileSync(evaluationFile, 'utf8');
            const hasViolations = content.includes('violations:') && !content.includes('violations: []');
            
            if (hasViolations) {
              comment += '‚ùå **FAILED** - License policy violations detected\n\n';
              comment += 'Review the [ORT Results](../artifacts) for detailed violation information.\n';
            } else {
              comment += '‚úÖ **PASSED** - All dependencies use MIT-compatible licenses\n\n';
            }
          } else {
            comment += '‚ö†Ô∏è **UNKNOWN** - Could not read evaluation results\n\n';
          }
          
          comment += '\nüì¶ View [License Reports](../artifacts) and [ORT Results](../artifacts) in workflow artifacts.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
