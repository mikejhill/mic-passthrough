name: ORT License Compliance

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:  # Allow manual triggering

jobs:
  ort-license-check:
    runs-on: ubuntu-latest
    name: ORT License Compliance Check
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Run ORT Analysis and Evaluation
      uses: oss-review-toolkit/ort-ci-github-action@v1
      with:
        # Package managers to analyze
        ort-cli-analyze-args: '--package-managers NuGet'
        
        # Use local policy rules for evaluation
        ort-cli-evaluate-args: '--rules-file ${{ github.workspace }}/.ort/policy/rules.kts'
        
        # Generate multiple report formats for comprehensive review
        report-formats: 'CycloneDx,SpdxDocument,WebApp'
        
        # Fail the build on policy violations (incompatible licenses)
        fail-on: 'violations'
        
        # Allow ORT to download package sources for license detection
        allow-dynamic-versions: 'true'

    - name: Upload ORT Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ort-results
        path: |
          .ort/analyzer/analyzer-result.yml
          .ort/evaluator/evaluation-result.yml
          .ort/reporter/**/*
        retention-days: 90
        
    - name: Upload License Reports
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: license-reports
        path: |
          .ort/reporter/*.html
          .ort/reporter/*.pdf
          .ort/reporter/*.spdx.*
          .ort/reporter/*.cyclonedx.*
        retention-days: 90

    - name: Comment PR with Results
      if: github.event_name == 'pull_request' && always()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          const evaluationFile = '.ort/evaluator/evaluation-result.yml';
          
          let comment = '## ORT License Compliance Results\n\n';
          
          if (fs.existsSync(evaluationFile)) {
            const content = fs.readFileSync(evaluationFile, 'utf8');
            const hasViolations = content.includes('violations:') && !content.includes('violations: []');
            
            if (hasViolations) {
              comment += '❌ **FAILED** - License policy violations detected\n\n';
              comment += 'Please review the ORT results artifact for details.\n';
            } else {
              comment += '✅ **PASSED** - All dependencies use approved licenses\n\n';
            }
          } else {
            comment += '⚠️ **UNKNOWN** - Could not read evaluation results\n\n';
          }
          
          comment += 'View detailed reports in the workflow artifacts.';
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
