name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.0.1, etc.

jobs:
  release:
    runs-on: windows-latest
    name: Build and Release

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        $tag = "${{ github.ref }}".Replace("refs/tags/", "")
        $version = $tag.TrimStart('v')
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Run tests
      # Verify tests pass before creating release
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Publish executable
      # Self-contained single-file with trimming and compression
      # Size: ~12MB (includes .NET runtime, no installation needed)
      # Alternative: Framework-dependent (~1.6MB) requires users to install .NET 10.0
      run: dotnet publish src/MicPassthrough/MicPassthrough.csproj --configuration Release --no-build --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=true -p:EnableCompressionInSingleFile=true --output ./publish
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Release ${{ steps.version.outputs.TAG }}"
        body: |
          # Microphone Passthrough v${{ steps.version.outputs.VERSION }}
          
          Low-latency audio passthrough application that routes microphone input to VB-Audio Virtual Cable. Solves the Phone Link USB microphone volume bug on Windows 10/11.
          
          ## Installation
          1. Download `MicPassthrough.exe` below
          2. Run from PowerShell or Command Prompt:
          ```powershell
          .\MicPassthrough.exe --mic "Your Microphone Name"
          ```
          
          Use `--list-devices` to see available audio devices, or `--help` for all options.
          
          ## Requirements
          - Windows 10/11
          - [VB-Audio Virtual Cable](https://vb-audio.com/Cable/) (free download)
          
          ## What's Changed
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for the complete changelog.
        files: ./publish/MicPassthrough.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
