name: Release

on:
  push:
    tags:
      - 'v*'  # Triggers on tags like v1.0.0, v1.0.1, etc.

jobs:
  release:
    runs-on: windows-latest
    name: Build and Release
    permissions:
      contents: write

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Extract version from tag
      id: version
      run: |
        $tag = "${{ github.ref }}".Replace("refs/tags/", "")
        $version = $tag.TrimStart('v')
        echo "VERSION=$version" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
      shell: pwsh

    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: '10.0.x'

    - name: Restore dependencies
      run: dotnet restore

    - name: Build
      run: dotnet build --configuration Release --no-restore

    - name: Run tests
      # Verify tests pass before creating release
      run: dotnet test --configuration Release --no-build --verbosity normal

    - name: Publish executable
      # Self-contained single-file with compression
      # Size: ~37MB (includes .NET runtime, no installation needed)
      # Alternative: Framework-dependent (~1.6MB) requires users to install .NET 10.0
      run: dotnet publish src/MicPassthrough/MicPassthrough.csproj --configuration Release --no-build --runtime win-x64 --self-contained true -p:PublishSingleFile=true -p:EnableCompressionInSingleFile=true --output ./publish
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        name: "Release ${{ steps.version.outputs.TAG }}"
        body: |
          # Microphone Passthrough v${{ steps.version.outputs.VERSION }}
          
          ## What's New
          See [CHANGELOG.md](https://github.com/${{ github.repository }}/blob/main/CHANGELOG.md) for details.
          
          ## Installation
          Download `MicPassthrough.exe` and run it from PowerShell:
          ```powershell
          .\MicPassthrough.exe --mic "Your Microphone Name" --cable "CABLE Input (VB-Audio Virtual Cable)"
          ```
          
          Use `--help` to see all options or `--list-devices` to discover available audio devices.
          
          ## Requirements
          - Windows 10/11
          - [VB-Audio Virtual Cable](https://vb-audio.com/Cable/)
          - .NET 10.0 Runtime (included in the executable)
          
          ## Changelog
          See [releases page](https://github.com/${{ github.repository }}/releases) for all versions.
        files: ./publish/MicPassthrough.exe
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
